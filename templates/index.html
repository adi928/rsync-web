<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plex Backup Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Plex Backup</h1>
            {{if .Configured}}
            <p class="subtitle">rsync mirror &middot; {{.Source}} &rarr; {{.Dest}}</p>
            {{else}}
            <p class="subtitle">Configure your backup settings below to get started.</p>
            {{end}}
        </header>

        {{if not .Configured}}
        <section class="section">
            {{template "settings-form" .}}
        </section>
        {{else}}
        <div id="status-card" hx-get="/fragment/status" hx-trigger="every 5s, backup-started from:body" hx-swap="outerHTML">
            {{template "status-card" .}}
        </div>

        <section class="section">
            <h2>Settings</h2>
            {{template "settings-form" .}}
        </section>

        <section class="section">
            <h2>History</h2>
            <div id="history-table" hx-get="/fragment/history" hx-trigger="every 10s" hx-swap="outerHTML">
                {{template "history-table" .}}
            </div>
        </section>

        <section class="section" id="log-viewer">
            <h2>Log Output</h2>
            <div id="log-content" class="log-box">
                <p class="muted">Select a backup run above to view its log.</p>
            </div>
        </section>
        {{end}}
    </div>
</body>
</html>

{{define "status-card"}}
<div id="status-card" hx-get="/fragment/status" hx-trigger="every 5s, backup-started from:body" hx-swap="outerHTML" class="card status-card">
    <div class="status-grid">
        <div class="status-item">
            <span class="label">Status</span>
            <span class="badge {{statusClass .Status}}">{{.Status}}</span>
        </div>
        <div class="status-item">
            <span class="label">Schedule</span>
            <span class="value">{{.Schedule}}</span>
        </div>
        <div class="status-item">
            <span class="label">Next Run</span>
            <span class="value">{{formatTime .NextRun}}</span>
        </div>
        <div class="status-item">
            <span class="label">Last Run</span>
            {{if .LastRun}}
            <span class="value">{{formatTime .LastRun.StartTime}}</span>
            {{else}}
            <span class="value muted">never</span>
            {{end}}
        </div>
        {{if .LastRun}}
        <div class="status-item">
            <span class="label">Duration</span>
            <span class="value">{{.LastRun.Duration}}</span>
        </div>
        <div class="status-item">
            <span class="label">Result</span>
            <span class="badge {{statusClass .LastRun.Status}}">{{.LastRun.Summary}}</span>
        </div>
        {{if eq .LastRun.Status "warning"}}
        <div class="status-hint warning-hint">
            Partial transfer &mdash; most files synced but some were skipped (exit code {{.LastRun.ExitCode}}). Re-running will retry the skipped files.
        </div>
        {{else if eq .LastRun.Status "failed"}}
        <div class="status-hint failed-hint">
            Backup failed (exit code {{.LastRun.ExitCode}}). Check the log for details.
        </div>
        {{end}}
        {{end}}
    </div>
    {{if not .History}}
    <div id="remote-warning"
         hx-get="/fragment/remote-warning"
         hx-trigger="load"
         hx-swap="outerHTML">
    </div>
    {{end}}
    <div class="actions">
        {{if eq .Status "running"}}
        <button class="btn" disabled>Backup Running&hellip;</button>
        {{else if not .Configured}}
        <button class="btn" disabled>Configure Settings First</button>
        {{else if not .History}}
        <button class="btn btn-primary"
                hx-post="/api/backup"
                hx-swap="none"
                hx-confirm="This is the first backup. The remote destination will be synced to match the source â€” any existing files at the destination not present in the source will be deleted (--delete). Continue?">
            Run Backup Now
        </button>
        {{else}}
        <button class="btn btn-primary"
                hx-post="/api/backup"
                hx-swap="none">
            Run Backup Now
        </button>
        {{end}}
    </div>
</div>
{{end}}

{{define "settings-form"}}
<div id="settings-form" class="card settings-card">
    {{if not .Configured}}
    <h2>Setup Required</h2>
    <p class="muted settings-desc">Enter your rsync transfer details to get started.</p>
    {{end}}
    <form hx-post="/api/settings" hx-target="#settings-form" hx-swap="outerHTML">
        <div class="form-grid">
            <div class="form-group">
                <label for="source_path">Source Path</label>
                <input type="text" id="source_path" name="source_path"
                       value="{{.Settings.SourcePath}}"
                       placeholder="/mnt/plex-media" required>
                <span class="form-hint">Local path to back up</span>
            </div>
            <div class="form-group form-checkbox">
                <label>
                    <input type="checkbox" name="source_is_file"
                           {{if .Settings.SourceIsFile}}checked{{end}}>
                    Source is a single file
                </label>
            </div>
            <div class="form-group">
                <label for="remote_host">Remote Host</label>
                <input type="text" id="remote_host" name="remote_host"
                       value="{{.Settings.RemoteHost}}"
                       placeholder="user@backup-server.example.com" required>
                <span class="form-hint">SSH destination in user@host format</span>
            </div>
            <div class="form-group">
                <label for="remote_path">Remote Path</label>
                <input type="text" id="remote_path" name="remote_path"
                       value="{{.Settings.RemotePath}}"
                       placeholder="/backups/plex-media" required>
                <span class="form-hint">Directory on the remote server</span>
            </div>
            <div class="form-group">
                <label for="ssh_key_path">SSH Key Path</label>
                <input type="text" id="ssh_key_path" name="ssh_key_path"
                       value="{{.Settings.SSHKeyPath}}"
                       placeholder="~/.ssh/plex-backup" required>
                <span class="form-hint">Private key (must have no passphrase)</span>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
    </form>
</div>
{{end}}

{{define "history-table"}}
<div id="history-table" hx-get="/fragment/history" hx-trigger="every 10s" hx-swap="outerHTML">
    {{if .History}}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Log</th>
            </tr>
        </thead>
        <tbody>
            {{range .History}}
            <tr>
                <td>{{formatTime .StartTime}}</td>
                <td>{{.Duration}}</td>
                <td>
                    <span class="badge badge-sm {{statusClass .Status}}">{{.Status}}</span>
                    {{if and (ne .Status "success") (ne .Status "running") (ne .Status "idle")}}
                    <span class="exit-code">exit {{.ExitCode}}</span>
                    {{end}}
                </td>
                <td>
                    <button class="btn btn-sm"
                            hx-get="/api/logs/{{.LogFile}}"
                            hx-target="#log-content"
                            hx-swap="innerHTML">
                        View
                    </button>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <p class="muted">No backup history yet.</p>
    {{end}}
</div>
{{end}}
